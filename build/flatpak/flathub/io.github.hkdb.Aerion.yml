app-id: io.github.hkdb.Aerion
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
  - org.freedesktop.Sdk.Extension.node20
command: aerion

finish-args:
  # Network access for email sync
  - --share=network
  # IPC is required for X11 and Wayland
  - --share=ipc
  # Display access
  - --socket=wayland
  - --socket=fallback-x11
  # GPU access for hardware acceleration
  - --device=dri
  # Sleep/wake detection for sync management
  - --system-talk-name=org.freedesktop.login1

modules:
  - name: aerion
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin:/usr/lib/sdk/node20/bin
      env:
        GOROOT: /usr/lib/sdk/golang
        GOPATH: /run/build/aerion/go
        GOCACHE: /run/build/aerion/go-cache
        GO111MODULE: 'on'
        CGO_ENABLED: '1'
        npm_config_cache: /run/build/aerion/flatpak-node/npm-cache
        npm_config_offline: 'true'

    build-commands:
      # Install frontend dependencies from offline cache
      - cd frontend && npm install --offline --legacy-peer-deps

      # Build frontend
      - cd frontend && npm run build

      # Build the Go binary using vendored modules (no ldflags needed;
      # OAuth credentials are loaded at runtime from the shim binary).
      # Tags: desktop (Wails runtime), webkit2_41 (GTK webkit API), production (embedded assets)
      - go build -mod=vendor -tags desktop,webkit2_41,production -ldflags "-w -s" -o aerion

      # Install binary
      - install -Dm755 aerion /app/bin/aerion

      # Install OAuth credentials shim binary
      - install -Dm755 aerion-creds /app/lib/aerion/aerion-creds

      # Install desktop file with correct app ID
      - install -Dm644 build/linux/aerion.desktop /app/share/applications/io.github.hkdb.Aerion.desktop
      - desktop-file-edit --set-key=Icon --set-value=io.github.hkdb.Aerion /app/share/applications/io.github.hkdb.Aerion.desktop
      - desktop-file-edit --set-key=Exec --set-value=aerion /app/share/applications/io.github.hkdb.Aerion.desktop

      # Install icon with correct app ID
      - install -Dm644 build/appicon.png /app/share/icons/hicolor/256x256/apps/io.github.hkdb.Aerion.png

      # Install metainfo (AppStream metadata)
      - install -Dm644 build/flatpak/io.github.hkdb.Aerion.metainfo.xml /app/share/metainfo/io.github.hkdb.Aerion.metainfo.xml

    sources:
      # Application source code (tag and commit updated by calculate-hashes.sh)
      - type: git
        url: https://github.com/hkdb/aerion.git
        tag: v0.1.18-test2
        commit: dc6901d734e1903ddac75a2f9efb9c161cedf6fa

      # Go module vendoring (generated by flatpak-go-mod, offline)
      - go.mod.yml

      # npm package vendoring (generated by flatpak-node-generator, offline)
      - node-sources.json

      # OAuth credentials shim binary (x86_64)
      - type: file
        url: https://github.com/hkdb/aerion/releases/download/v0.1.18-test2/aerion-creds-v0.1.18-test2-linux-x86_64
        sha256: 9ba165d9c88202a20dd621e340514f9aada28336fcd094199a7d8e4c657588a8
        dest-filename: aerion-creds
        only-arches:
          - x86_64

      # OAuth credentials shim binary (aarch64)
      - type: file
        url: https://github.com/hkdb/aerion/releases/download/v0.1.18-test2/aerion-creds-v0.1.18-test2-linux-aarch64
        sha256: 655efab877a19d36ef95e75e0feb7fe2bbb649d54218cbd7124cb8b1bdc8b550
        dest-filename: aerion-creds
        only-arches:
          - aarch64

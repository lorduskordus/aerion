# Extracted AppImage-related sections from Makefile
# Archived: February 2026

# === Variables ===

# Wails build tags
BUILD_TAGS := webkit2_41

# AppImage tools directory and architecture detection
TOOLS_DIR := $(CURDIR)/.tools
HOST_ARCH := $(shell uname -m)
ifeq ($(HOST_ARCH),aarch64)
    ARCH := aarch64
    LINUXDEPLOY := $(TOOLS_DIR)/linuxdeploy-aarch64.AppImage
    APPIMAGE_RUNTIME := $(TOOLS_DIR)/runtime-aarch64
else
    ARCH := x86_64
    LINUXDEPLOY := $(TOOLS_DIR)/linuxdeploy-x86_64.AppImage
    APPIMAGE_RUNTIME := $(TOOLS_DIR)/runtime-x86_64
endif

# Detect webkit helper directory (architecture-specific)
ifeq ($(ARCH),aarch64)
    WEBKIT_HELPERS_DIR := /usr/lib/aarch64-linux-gnu/webkit2gtk-4.1
else
    WEBKIT_HELPERS_DIR := /usr/lib/x86_64-linux-gnu/webkit2gtk-4.1
endif

# === Targets ===

# Download linuxdeploy tool (architecture-specific)
$(LINUXDEPLOY):
	@mkdir -p $(TOOLS_DIR)
	@echo "Downloading linuxdeploy for $(ARCH)..."
	curl -L --retry 3 --retry-delay 5 --connect-timeout 30 -o $(LINUXDEPLOY) \
		https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-$(ARCH).AppImage
	chmod +x $(LINUXDEPLOY)

# Download AppImage runtime (architecture-specific)
$(APPIMAGE_RUNTIME):
	@mkdir -p $(TOOLS_DIR)
	@echo "Downloading AppImage runtime for $(ARCH)..."
	curl -L --retry 3 --retry-delay 5 --connect-timeout 30 -o $(APPIMAGE_RUNTIME) \
		https://github.com/AppImage/type2-runtime/releases/download/continuous/runtime-$(ARCH)

# Build Linux AppImage
appimage: build-linux $(LINUXDEPLOY) $(APPIMAGE_RUNTIME)
	@echo "Creating AppImage..."
	@rm -rf build/linux/AppDir
	@mkdir -p build/linux/AppDir/usr/bin
	@mkdir -p build/linux/AppDir/usr/share/applications
	@mkdir -p build/linux/AppDir/usr/share/icons/hicolor/256x256/apps
	@mkdir -p build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1
	cp build/bin/aerion build/linux/AppDir/usr/bin/
	cp build/linux/aerion.desktop build/linux/AppDir/usr/share/applications/
	cp build/appicon.png build/linux/AppDir/usr/share/icons/hicolor/256x256/apps/aerion.png
	@echo "Creating /lib symlink for webkit compatibility..."
	ln -sf usr/lib build/linux/AppDir/lib
	@echo "Bundling webkit2gtk helper processes..."
	@if [ -d "$(WEBKIT_HELPERS_DIR)" ]; then \
		cp -r $(WEBKIT_HELPERS_DIR)/* build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/; \
		echo "Webkit helpers bundled from $(WEBKIT_HELPERS_DIR) to usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/"; \
		echo "Creating wrapper scripts for webkit helpers..."; \
		for helper in WebKitNetworkProcess WebKitWebProcess WebKitGPUProcess; do \
			if [ -f "build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/$$helper" ]; then \
				mv "build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/$$helper" \
				   "build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/$$helper.bin"; \
				cp build/linux/webkit-wrapper.sh "build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/$$helper"; \
				chmod +x "build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/webkit2gtk-4.1/$$helper"; \
			fi; \
		done; \
	else \
		echo "Warning: webkit2gtk helpers not found at $(WEBKIT_HELPERS_DIR)"; \
		echo "AppImage may not work on systems without webkit2gtk installed"; \
	fi
	@echo "Bundling GDK pixbuf loaders..."
	@mkdir -p build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders
	@if [ -d "/usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders" ]; then \
		cp -r /usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders/* \
		      build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders/; \
		echo "Pixbuf loaders bundled"; \
	fi
	@echo "Generating pixbuf loaders cache..."
	@GDK_PIXBUF_MODULEDIR=$(CURDIR)/build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders \
		gdk-pixbuf-query-loaders 2>/dev/null | \
		sed 's|$(CURDIR)/build/linux/AppDir||g' > build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders.cache || \
		echo "# loaders.cache" > build/linux/AppDir/usr/lib/$(ARCH)-linux-gnu/gdk-pixbuf-2.0/2.10.0/loaders.cache
	@echo "Preparing custom AppRun script..."
	chmod +x build/linux/AppRun
	cd $(CURDIR) && ARCH=$(ARCH) \
		LDAI_RUNTIME_FILE=$(APPIMAGE_RUNTIME) \
		$(LINUXDEPLOY) \
		--appdir build/linux/AppDir \
		--custom-apprun build/linux/AppRun \
		--desktop-file build/linux/AppDir/usr/share/applications/aerion.desktop \
		--icon-file build/linux/AppDir/usr/share/icons/hicolor/256x256/apps/aerion.png \
		--output appimage
	@mv Aerion-*.AppImage build/bin/ 2>/dev/null || mv aerion-*.AppImage build/bin/
	@rm -rf build/linux/AppDir
	@echo "AppImage created at build/bin/"

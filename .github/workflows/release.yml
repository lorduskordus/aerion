name: Release

on:
  push:
    tags: 'v*'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            arch: amd64
          - os: ubuntu-22.04-arm
            platform: linux
            arch: arm64
          - os: macos-latest
            platform: darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: windows-latest
            platform: windows
            arch: arm64
    runs-on: ${{ matrix.os }}
    env:
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build (Linux)
        if: matrix.platform == 'linux'
        run: |
          make build-linux

          # Rename binary with version tag
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            mv build/bin/aerion build/bin/aerion-${{ github.ref_name }}-linux-x86_64
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            mv build/bin/aerion build/bin/aerion-${{ github.ref_name }}-linux-aarch64
          fi

          # Build OAuth credentials shim binary
          if [ "${{ matrix.arch }}" = "amd64" ]; then
            CGO_ENABLED=0 GOARCH=amd64 go build \
              -ldflags "-X 'main.GoogleClientID=$GOOGLE_CLIENT_ID' -X 'main.GoogleClientSecret=$GOOGLE_CLIENT_SECRET' -X 'main.MicrosoftClientID=$MICROSOFT_CLIENT_ID'" \
              -o build/bin/aerion-creds-${{ github.ref_name }}-linux-x86_64 \
              cmd/aerion-creds/main.go
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            CGO_ENABLED=0 GOARCH=arm64 go build \
              -ldflags "-X 'main.GoogleClientID=$GOOGLE_CLIENT_ID' -X 'main.GoogleClientSecret=$GOOGLE_CLIENT_SECRET' -X 'main.MicrosoftClientID=$MICROSOFT_CLIENT_ID'" \
              -o build/bin/aerion-creds-${{ github.ref_name }}-linux-aarch64 \
              cmd/aerion-creds/main.go
          fi

          # Create distribution tarball (complete package for manual installation)
          mkdir -p dist-package
          cp build/bin/aerion-${{ github.ref_name }}-linux-* dist-package/aerion
          cp build/linux/install.sh dist-package/
          cp build/linux/uninstall.sh dist-package/
          cp build/linux/aerion.desktop dist-package/io.github.hkdb.Aerion.desktop
          cp build/linux/aerion.png dist-package/io.github.hkdb.Aerion.png

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            tar czf aerion-linux-amd64.tar.gz -C dist-package .
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            tar czf aerion-linux-arm64.tar.gz -C dist-package .
          fi

          rm -rf dist-package

      - name: Build (macOS)
        if: matrix.platform == 'darwin'
        env:
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          cd build/bin
          zip -r Aerion-darwin-${{ matrix.arch }}.zip Aerion.app
          rm -rf Aerion.app

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          Move-Item build/bin/aerion.exe build/bin/Aerion-windows-${{ matrix.arch }}.exe

      - uses: actions/upload-artifact@v4
        with:
          name: aerion-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.variant && format('-{0}', matrix.variant) || '' }}
          path: |
            build/bin/aerion-*
            build/bin/Aerion-*
            aerion-*.tar.gz
          retention-days: 1

  publish:
    needs: build
    runs-on: ubuntu-latest
    env:
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    outputs:
      release-id: ${{ steps.create-release.outputs.id }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4

      - name: Create GitHub Release
        id: create-release
        run: |
          TAG_NAME=${{ github.ref_name }}

          # Upload all artifacts (binaries, shim binaries, tarballs)
          gh release upload $TAG_NAME \
            aerion-*/build/bin/* \
            aerion-*/*.tar.gz \
            --clobber

  update-manifest:
    needs: publish
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget

      - name: Calculate hashes and update manifest
        run: |
          cd build/flatpak/flathub
          chmod +x calculate-hashes.sh
          ./calculate-hashes.sh ${{ github.ref_name }}

      - name: Upload updated manifest
        uses: actions/upload-artifact@v4
        with:
          name: flathub-manifest
          path: build/flatpak/flathub/io.github.hkdb.Aerion.yml
          retention-days: 1

  build-flatpak:
    needs: update-manifest
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: flathub-manifest
          path: build/flatpak/flathub

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder

      - name: Add Flathub repository
        run: flatpak remote-add --if-not-exists --user flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Flatpak runtimes and SDK extensions
        run: |
          flatpak install -y --user flathub \
            org.gnome.Platform//49 \
            org.gnome.Sdk//49 \
            org.freedesktop.Sdk.Extension.golang//24.08 \
            org.freedesktop.Sdk.Extension.node20//24.08

      - name: Clean flatpak-builder cache
        run: |
          rm -rf .flatpak-builder

      - name: Build Flatpak (like Flathub would)
        run: |
          flatpak-builder --user --force-clean --repo=repo \
            --install-deps-from=flathub \
            build-dir build/flatpak/flathub/io.github.hkdb.Aerion.yml

          mkdir -p build/bin
          flatpak build-bundle repo build/bin/Aerion-${{ github.ref_name }}-${{ matrix.arch }}.flatpak io.github.hkdb.Aerion

      - name: Upload Flatpak to release
        run: |
          gh release upload ${{ github.ref_name }} \
            build/bin/Aerion-${{ github.ref_name }}-${{ matrix.arch }}.flatpak \
            --clobber

  commit-manifest:
    needs: build-flatpak
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: flathub-manifest
          path: build/flatpak/flathub

      - name: Commit updated manifest
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main:main
          git checkout main
          git add build/flatpak/flathub/io.github.hkdb.Aerion.yml
          git commit -m "${{ github.ref_name }} - Flathub submission" || echo "No changes to commit"
          git push origin main

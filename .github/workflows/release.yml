name: Release

on:
  push:
    tags: 'v*'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            arch: amd64
          - os: ubuntu-22.04-arm
            platform: linux
            arch: arm64
          - os: macos-latest
            platform: darwin
            arch: amd64
          - os: macos-latest
            platform: darwin
            arch: arm64
          - os: windows-latest
            platform: windows
            arch: amd64
          - os: windows-latest
            platform: windows
            arch: arm64
    runs-on: ${{ matrix.os }}
    env:
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build (Linux)
        if: matrix.platform == 'linux'
        run: |
          make build-linux
          mv build/bin/aerion build/bin/aerion-linux-${{ matrix.arch }}

          # Create tarball for Flatpak extra-data
          mkdir -p flatpak-binary
          cp build/bin/aerion-linux-${{ matrix.arch }} flatpak-binary/aerion

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            tar czf aerion-${{ github.ref_name }}-linux-x86_64.tar.gz -C flatpak-binary aerion
          elif [ "${{ matrix.arch }}" = "arm64" ]; then
            tar czf aerion-${{ github.ref_name }}-linux-aarch64.tar.gz -C flatpak-binary aerion
          fi

          rm -rf flatpak-binary

      - name: Build (macOS)
        if: matrix.platform == 'darwin'
        env:
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          cd build/bin
          zip -r Aerion-darwin-${{ matrix.arch }}.zip Aerion.app
          rm -rf Aerion.app

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          GOARCH: ${{ matrix.arch }}
        run: |
          make build
          Move-Item build/bin/aerion.exe build/bin/Aerion-windows-${{ matrix.arch }}.exe

      - uses: actions/upload-artifact@v4
        with:
          name: aerion-${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.variant && format('-{0}', matrix.variant) || '' }}
          path: |
            build/bin/aerion-*
            build/bin/Aerion-*
            aerion-*.tar.gz
          retention-days: 1

  build-flatpak:
    runs-on: ubuntu-latest
    container:
      image: ubuntu:noble-20260113
      options: --privileged
    env:
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      MICROSOFT_CLIENT_ID: ${{ secrets.MICROSOFT_CLIENT_ID }}
      DEBIAN_FRONTEND: noninteractive
      CGO_ENABLED: 1
      PATH: /usr/local/go/bin:/github/home/go/bin:/usr/local/node-v20.11.0-linux-x64/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            flatpak flatpak-builder git \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            build-essential wget pkg-config

      - name: Set up Go
        run: |
          wget -q https://go.dev/dl/go1.23.0.linux-amd64.tar.gz
          tar -C /usr/local -xzf go1.23.0.linux-amd64.tar.gz

      - name: Set up Node.js
        run: |
          wget -qO- https://nodejs.org/dist/v20.11.0/node-v20.11.0-linux-x64.tar.xz | tar -xJ -C /usr/local

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest
          wails version

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm install

      - name: Build binary on host
        run: make build-linux

      - name: Add Flathub repository
        run: flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Install Flatpak runtimes
        run: |
          flatpak install -y flathub \
            org.gnome.Platform//47 \
            org.gnome.Sdk//47

      - name: Package into Flatpak
        run: |
          flatpak-builder --force-clean --repo=repo build-dir build/flatpak/com.github.hkdb.Aerion-prebuilt.yml
          mkdir -p build/bin
          flatpak build-bundle repo build/bin/Aerion-${{ github.ref_name }}.flatpak com.github.hkdb.Aerion

      - uses: actions/upload-artifact@v4
        with:
          name: aerion-flatpak
          path: build/bin/Aerion-*.flatpak
          retention-days: 1

  publish:
    needs:
      - build
      - build-flatpak
    runs-on: ubuntu-latest
    env:
      GH_REPO: ${{ github.repository }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4

      - name: Publish release
        run: |
          TAG_NAME=${{ github.ref_name }}

          # Update Flathub manifest with current tag and commit
          sed -i "s/tag: .*/tag: ${TAG_NAME}/" build/flatpak/flathub/com.github.hkdb.Aerion.yml
          sed -i "s/# commit: .*/commit: ${GITHUB_SHA}/" build/flatpak/flathub/com.github.hkdb.Aerion.yml

          # Create Flathub submission package
          mkdir -p flathub-submission
          cp build/flatpak/flathub/com.github.hkdb.Aerion.yml flathub-submission/
          cp build/flatpak/com.github.hkdb.Aerion.metainfo.xml flathub-submission/
          cp build/flatpak/flathub/README.md flathub-submission/
          tar -czf flathub-submission.tar.gz flathub-submission/

          # Upload all artifacts
          gh release upload $TAG_NAME \
            aerion-*/build/bin/* \
            aerion-*/*.tar.gz \
            aerion-flatpak/*.flatpak \
            build/linux/aerion.desktop \
            flathub-submission.tar.gz \
            --clobber
